<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEB'S LOGISTICS</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/truck.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        :root {
            --primary-color: #5E72E4; --secondary-color: #F4F5F7; --success-color: #2DCE89;
            --info-color: #11CDEF; --warning-color: #FB6340; --danger-color: #F5365C;
            --sidebar-bg: #172B4D; --sidebar-text: #8898AA; --sidebar-hover-bg: #1F3866;
            --sidebar-active-text: #ffffff; --content-bg: #F8F9FE; --card-bg: #ffffff;
            --text-dark: #32325D; --text-muted: #8898AA; --border-color: #E9ECEF;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--content-bg); }
        #app-container { display: none; }
        .view { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 10002; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); display: none; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10003; }
        .toast-notification { padding: 15px 20px; color: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; }
        .toast-notification.success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%) !important; }
        .toast-notification.error { background: linear-gradient(87deg, #f5365c 0, #f56036 100%) !important; }
        .toast-notification.info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%) !important; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #172B4D; z-index: 2000; }
        #login-video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.4); }
        #login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.2); color: white; }
        #login-container .form-control { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; }
        #login-container .form-control::placeholder { color: rgba(255,255,255,0.7); }
        .wrapper { display: flex; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; height: 100vh; z-index: 1001; transition: all 0.3s ease-in-out; box-shadow: 0 0 2rem 0 rgba(136,152,170,.15); }
        .sidebar .logo { font-size: 1.2rem; font-weight: 600; text-align: center; color: white; padding: 22px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar .logo i { color: var(--info-color); }
        .sidebar .nav-link { color: var(--sidebar-text); padding: 12px 25px; border-radius: .375rem; margin: 0 1rem 5px; transition: all 0.2s ease; white-space: nowrap; cursor: pointer; display: flex; align-items: center; justify-content: space-between;}
        .sidebar .nav-link:hover { background-color: var(--sidebar-hover-bg); color: var(--sidebar-active-text); }
        .sidebar .nav-link.active { background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%) !important; color: var(--sidebar-active-text); font-weight: 500; box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); }
        .sidebar .nav-link .nav-link-text { display: flex; align-items: center; }
        .sidebar .nav-link .nav-link-text i { margin-right: 15px; width: 20px; text-align: center; font-size: .95rem; }
        .sidebar .user-profile { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding: 15px 10px; text-align: center; }
        .main-content { width: 100%; padding: 30px; margin-left: 260px; transition: margin-left 0.3s ease-in-out; }
        .card { border: none; border-radius: .5rem; box-shadow: 0 1px 3px rgba(50,50,93,.15), 0 1px 0 rgba(0,0,0,.02); }
        .card-header { background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); font-weight: 600; padding: 1.25rem 1.5rem; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 2.5rem; margin-bottom: 1rem; }
        .table-hover>tbody>tr:hover>* { background-color: #f6f9fc; }
    </style>
</head>
<body>
    <div id="loader-overlay"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-container"></div>

    <div id="login-wrapper">
        <video autoplay muted loop id="login-video-bg"> <source src="https://laserpowerinfra.com/frontassets/img/slider/Banner_v04_HD_L.mp4" type="video/mp4"> </video>
        <div id="login-container" class="p-4 p-md-5">
            <h2 class="text-center mb-1 fw-bold"><i class="fas fa-truck text-info"></i> DEB'S LOGISTICS</h2>
            <p class="text-center mb-4">Login to your account</p>
            <form id="login-form">
                <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3"><input type="password" id="password" class="form-control" placeholder="Password" required></div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
            </form>
            <div id="login-error-msg" class="text-danger text-center small mt-2 fw-bold" style="display: none;"></div>
            <p class="text-center mt-3 small">Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Register Now</a></p>
        </div>
    </div>

    <div id="app-container" class="wrapper">
        <nav class="sidebar" id="sidebar">
            <div class="logo"> <i class="fas fa-truck"></i> <span>DEB'S LOGISTICS</span> </div>
            <div id="nav-links" class="flex-grow-1">
                <a class="nav-link admin-nav-item" data-view="admin-dashboard-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></div></a>
                <a class="nav-link admin-nav-item" data-view="admin-pending-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-inbox"></i> <span>Load Approvals</span></div></a>
                <a class="nav-link admin-nav-item" data-view="admin-active-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-truck-loading"></i> <span>Active Loads</span></div></a>
                <a class="nav-link admin-nav-item" data-view="admin-bidding-history-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-history"></i> <span>Bidding History</span></div></a>
                <a class="nav-link admin-nav-item" data-view="admin-user-control-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-users-cog"></i> <span>User Control</span></div></a>
                
                <a class="nav-link vendor-nav-item" data-view="vendor-dashboard-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></div></a>
                <a class="nav-link vendor-nav-item" data-view="vendor-open-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-clipboard-list"></i> <span>Open Loads for Bidding</span></div></a>
                <a class="nav-link vendor-nav-item" data-view="vendor-my-bids-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-gavel"></i> <span>My Bidding History</span></div></a>

                <a class="nav-link user-nav-item" data-view="user-create-load-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-plus-circle"></i> <span>Post a New Load</span></div></a>
                <a class="nav-link user-nav-item" data-view="user-status-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-history"></i> <span>My Load Status</span></div></a>
            </div>
            <div class="user-profile">
                <div><h6 id="user-name-sidebar" class="mb-0 text-white"></h6><small id="user-email-sidebar" class="text-muted"></small></div>
                <button onclick="handleLogout()" class="btn btn-sm btn-outline-danger w-100 mt-2"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></button>
            </div>
        </nav>

        <main class="main-content" id="main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 id="header-title" class="h4 mb-0 fw-bold text-dark"></h1>
                <button class="btn btn-sm btn-outline-primary" onclick="handleManualRefresh()"><i class="fas fa-sync-alt me-2"></i>Refresh Data</button>
            </div>
            <div id="main-view"></div>
        </main>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white"><h5 class="modal-title">Create Account</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="register-form">
                        <div class="mb-3"><select id="reg-role" class="form-select" required><option value="">Register as...</option><option value="User">Shipper (I have loads)</option><option value="Vendor">Trucker (I have trucks)</option></select></div>
                        <div class="mb-2"><input type="text" id="reg-fullname" class="form-control" placeholder="Full Name" required></div>
                        <div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div>
                        <div class="mb-2"><input type="password" id="reg-password" class="form-control" placeholder="Password" required></div>
                        <div class="mb-2"><input type="text" id="reg-contact" class="form-control" placeholder="Contact Number" required></div>
                        <div class="mb-2" id="reg-company-wrapper" style="display: none;"><input type="text" id="reg-company" class="form-control" placeholder="Company Name"></div>
                        <div class="mb-3" id="reg-gstin-wrapper" style="display: none;"><input type="text" id="reg-gstin" class="form-control" placeholder="GSTIN (Optional)"></div>
                        <button type="submit" class="btn btn-success w-100 fw-bold">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="adminActionModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="adminActionModalTitle">Bids for Load</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="adminActionModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-success" onclick="handleAwardSubmit()">Award Selected Bid</button></div></div></div></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
    // =========================================================
    // ================ CONFIG & STATE =========================
    // =========================================================
    const API_BASE_URL = '/api';
    let MASTER_DATA = { truckTypes: [], items: [] };
    let loginWrapper, appContainer, mainView, headerTitle;
    let registerModal, adminActionModal;

    // =========================================================
    // =================== VIEW TEMPLATES ======================
    // =========================================================
    const views = {
        'admin-dashboard-view': `<div class="card"><div class="card-body">Admin Dashboard Coming Soon...</div></div>`,
        'admin-pending-loads-view': `<div class="card"><div class="card-header"><h5 class="mb-0">Pending Load Approvals</h5></div><div class="card-body"><div id="pending-loads-container"></div></div></div>`,
        'admin-active-loads-view': `<div class="card"><div class="card-header"><h5 class="mb-0">All Active Loads</h5></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle"><thead><tr><th>Req ID</th><th>Shipper</th><th>Route</th><th>Details</th><th>Assigned Truckers</th><th>Status</th><th>Actions</th></tr></thead><tbody id="admin-loads-tbody"></tbody></table><div id="admin-loads-empty-state"></div></div></div>`,
        'admin-bidding-history-view': `<div class="card"><div class="card-body">Bidding History Coming Soon...</div></div>`,
        'admin-user-control-view': `<div class="card"><div class="card-body">User Control Coming Soon...</div></div>`,
        
        'vendor-dashboard-view': `<div class="card"><div class="card-body">Trucker Dashboard Coming Soon...</div></div>`,
        'vendor-open-loads-view': `<div class="d-flex justify-content-end align-items-center mb-3"><button class="btn btn-success" onclick="handleBulkBidSubmit()"><i class="fas fa-check-double me-2"></i>Submit All Entered Bids</button></div><div class="card"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle"><thead><tr><th>Route</th><th>Load Details</th><th>Weight</th><th>Truck Type</th><th>Date</th><th>My Rank</th><th>My Bid History</th><th>Your Bid (₹)</th></tr></thead><tbody id="vendor-loads-tbody"></tbody></table></div><div id="vendor-loads-empty-state"></div></div></div>`,
        'vendor-my-bids-view': `<div class="card"><div class="card-body">My Bidding History Coming Soon...</div></div>`,
        
        'user-create-load-view': `<div class="card"><div class="card-header"><h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Post a New Truck Load</h5></div><div class="card-body"><form id="create-load-form"><div id="load-items-container"></div><hr/><button type="submit" class="btn btn-primary w-100 fw-bold">Submit Load Request for Approval</button></form></div></div>`,
        'user-status-view': `<div class="card"><div class="card-header"><h5 class="mb-0"><i class="fas fa-history me-2"></i>My Load Request Status</h5></div><div class="card-body" id="user-req-status-list"></div></div>`,
    };
    
    // =========================================================
    // ================ CORE APP LOGIC =========================
    // =========================================================
    $(document).ready(() => {
        loginWrapper = $('#login-wrapper'); 
        appContainer = $('#app-container'); 
        mainView = $('#main-view'); 
        headerTitle = $('#header-title');
        
        try { 
            registerModal = new bootstrap.Modal('#registerModal');
            adminActionModal = new bootstrap.Modal('#adminActionModal');
        } catch (e) { console.error("Error initializing modals:", e); }
        
        const user = sessionStorage.getItem('loggedInUser');
        if (user && sessionStorage.getItem('authToken')) {
            setupUIForRole(JSON.parse(user));
        }
        
        $('#login-form').on('submit', handleLogin);
        $('#register-form').on('submit', handleRegistration);
        $(document).on('submit', '#create-load-form', handleLoadSubmit);
        $('#reg-role').on('change', handleRoleChange);
    });

    async function apiCall(endpoint, method = 'GET', body = null) {
        showLoader();
        try {
            const headers = { 'Content-Type': 'application/json' };
            const token = sessionStorage.getItem('authToken');
            if (token) headers['Authorization'] = `Bearer ${token}`;
            
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            const response = await fetch(API_BASE_URL + endpoint, options);
            const result = await response.json();
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) handleLogout();
                throw new Error(result.message || `API Error: ${response.statusText}`);
            }
            return result;
        } catch (error) {
            showToast(error.message, 'error');
            throw error;
        } finally {
            hideLoader();
        }
    }

    function navigateTo(viewId) {
        mainView.html(views[viewId]);
        $('#nav-links .nav-link').removeClass('active');
        const navLink = $(`[data-view="${viewId}"]`);
        if (navLink.length) {
            navLink.addClass('active');
            headerTitle.text(navLink.find('span').text().trim());
        }
        const loadFunctionName = `load_${viewId.replace(/-/g, '_')}`;
        if (typeof window[loadFunctionName] === 'function') {
            window[loadFunctionName]();
        }
    }

    async function handleManualRefresh() {
        const currentViewLink = $('#nav-links .nav-link.active');
        if (currentViewLink.length > 0) {
            showToast('Refreshing data...', 'info');
            if (currentViewLink.data('view') === 'user-create-load-view') {
                MASTER_DATA = { truckTypes: [], items: [] };
            }
            navigateTo(currentViewLink.data('view'));
        }
    }
    
    // =========================================================
    // ================= AUTH FUNCTIONS ======================
    // =========================================================
    async function handleLogin(e) {
        e.preventDefault();
        const email = $('#email').val(), password = $('#password').val();
        try {
            const result = await apiCall('/login', 'POST', { email, password });
            sessionStorage.setItem('loggedInUser', JSON.stringify(result.user));
            sessionStorage.setItem('authToken', result.token);
            await setupUIForRole(result.user);
        } catch (error) {
            $('#login-error-msg').text(error.message || 'Invalid credentials.').show();
        }
    }

    function handleLogout() {
        sessionStorage.clear();
        window.location.reload();
    }

    function handleRoleChange() {
        const isVendor = $('#reg-role').val() === 'Vendor';
        $('#reg-company-wrapper').css('display', isVendor ? 'block' : 'none');
        $('#reg-gstin-wrapper').css('display', isVendor ? 'block' : 'none');
        $('#reg-company').prop('required', isVendor);
    }

    async function handleRegistration(e) {
        e.preventDefault();
        const data = { FullName: $('#reg-fullname').val(), Email: $('#reg-email').val(), Password: $('#reg-password').val(), Role: $('#reg-role').val(), CompanyName: $('#reg-company').val(), ContactNumber: $('#reg-contact').val(), GSTIN: $('#reg-gstin').val() };
        const result = await apiCall('/register', 'POST', data);
        if (result.success) {
            showToast(result.message, 'success');
            registerModal.hide();
            $(e.target)[0].reset();
        }
    }
    
    async function setupUIForRole(user) {
        loginWrapper.hide();
        appContainer.show();
        $('#user-name-sidebar').text(user.full_name);
        $('#user-email-sidebar').text(user.email);
        $('#nav-links .nav-link').hide();
        
        if (user.role === 'Admin' || user.role === 'Super Admin') { $('.admin-nav-item').css('display', 'flex'); }
        if (user.role === 'Vendor') { $('.vendor-nav-item').css('display', 'flex'); }
        if (user.role === 'User') { $('.user-nav-item').css('display', 'flex'); }

        const defaultViewMap = { 'Super Admin': 'admin-dashboard-view', 'Admin': 'admin-dashboard-view', 'Vendor': 'vendor-dashboard-view', 'User': 'user-create-load-view' };
        navigateTo(defaultViewMap[user.role]);
    }

    // =========================================================
    // =================== VIEW LOADERS ========================
    // =========================================================
    async function fetchMasterData() {
        if (MASTER_DATA.truckTypes.length === 0 || MASTER_DATA.items.length === 0) {
            showToast('Loading master data...', 'info');
            try {
                const [trucksRes, itemsRes] = await Promise.all([
                    apiCall('/master-data/truck-types'),
                    apiCall('/master-data/items')
                ]);
                MASTER_DATA.truckTypes = trucksRes.data;
                MASTER_DATA.items = itemsRes.data;
            } catch (e) {
                throw new Error('Failed to load master data. Please refresh.');
            }
        }
    }

    async function load_user_create_load_view() {
        try {
            await fetchMasterData();
            $('#load-items-container').html(getLoadItemHtml());
            $('.item-id-select, .truck-type-select').select2({ theme: "bootstrap-5" });
        } catch (e) {
            $('#load-items-container').html(`<div class="alert alert-danger">${e.message}</div>`);
        }
    }

    async function load_user_status_view() {
        const listDiv = $('#user-req-status-list').html('<div class="text-center p-4">Loading...</div>'); 
        const result = await apiCall('/requisitions/my-status');
        if (!result.success || result.data.length === 0) {
            return renderEmptyState('#user-req-status-list', 'You have not posted any loads yet.', 'fa-file-signature');
        }
        listDiv.html('');
        result.data.forEach(req => {
            const loadsHTML = req.loads.map(load => `
                <li class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <small><strong>${load.item_name}</strong> to ${load.unloading_point_address.substring(0,30)}...</small>
                        <span class="badge bg-${getBadgeColor(load.status)}">${load.status}</span>
                    </div>
                    ${load.status === 'Awarded' ? `<small class="d-block text-success">Awarded to: ${load.awarded_vendor || 'N/A'} (Amount: ${formatCurrency(load.awarded_amount)})</small>` : ''}
                </li>`).join('');
            listDiv.append(`<div class="card mb-3"><div class="card-header d-flex justify-content-between"><strong>Req ID: REQ-${req.requisition_id}</strong><span class="badge bg-${getBadgeColor(req.status)}">${req.status}</span></div><ul class="list-group list-group-flush">${loadsHTML}</ul></div>`);
        });
    }
        
    async function load_vendor_open_loads_view() {
        const result = await apiCall('/requirements/assigned');
        const tableBody = $('#vendor-loads-tbody');
        tableBody.empty();
        if (!result.success || result.data.length === 0) {
            return renderEmptyState('#vendor-loads-empty-state', 'No open loads assigned for bidding.', 'fa-clipboard-list');
        }
        $('#vendor-loads-empty-state').html('');
        result.data.forEach(load => {
            let historyHtml = '<small class="text-muted">No bids yet</small>';
            if (load.my_bid_history && load.my_bid_history.length > 0) {
                historyHtml = load.my_bid_history.map(bid => `<div><span class="badge bg-secondary">${formatCurrency(bid.bid_amount)} (Rank: L${bid.rank || 'N/A'})</span></div>`).join('');
            }
            const rowHtml = `<tr data-load-id="${load.load_id}">
                <td><small><strong>From:</strong> ${load.loading_point_address}<br><strong>To:</strong> ${load.unloading_point_address}</small></td>
                <td>${load.item_name}</td><td>${load.approx_weight_tonnes} MT</td><td>${load.truck_name}</td>
                <td>${formatDate(load.requirement_date)}</td>
                <td>${load.my_rank ? `<span class="badge bg-primary fs-6">L${load.my_rank}</span>` : '<span class="text-muted">Not Bid</span>'}</td>
                <td>${historyHtml}</td>
                <td><input type="number" step="100" class="form-control form-control-sm bid-amount" placeholder="e.g., 25000"></td></tr>`;
            tableBody.append(rowHtml);
        });
    }

    async function load_admin_pending_loads_view() {
         const container = $('#pending-loads-container').html('<div class="text-center p-4">Loading...</div>');
         const result = await apiCall('/requirements/pending');
         if (!result.success || result.data.groupedReqs.length === 0) {
            return renderEmptyState('#pending-loads-container', 'No loads are pending approval.', 'fa-inbox');
         }
         const { groupedReqs, pendingLoads, allTruckers } = result.data;
         container.html('<div class="accordion" id="pending-reqs-accordion"></div>');
         const accordion = $('#pending-reqs-accordion');
         groupedReqs.forEach(req => {
            const reqId = req.requisition_id;
            const reqLoads = pendingLoads.filter(load => load.requisition_id == reqId);
            const loadsHTML = reqLoads.map(load => `<li class="list-group-item"><input class="form-check-input me-2 load-check-box" type="checkbox" value="${load.load_id}" checked><label class="form-check-label">${load.item_name} (${load.approx_weight_tonnes} MT) from ${load.loading_point_address.substring(0,20)}...</label></li>`).join('');
            const truckersHTML = allTruckers.map(v => `<div class="form-check form-check-inline"><input class="form-check-input trucker-assign-check" type="checkbox" value="${v.user_id}"><label class="form-check-label">${v.full_name}</label></div>`).join('');
            accordion.append(`<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${reqId}">Req ID: REQ-${reqId} (By: ${req.creator}) - ${reqLoads.length} loads</button></h2><div id="collapse-${reqId}" class="accordion-collapse collapse" data-bs-parent="#pending-reqs-accordion"><div class="accordion-body"><h6>Select loads to approve:</h6><ul class="list-group mb-3">${loadsHTML}</ul><h6>Assign truckers:</h6><div class="border rounded p-2">${truckersHTML}</div><div class="mt-3"><button class="btn btn-success" onclick="handleBulkApproval('${reqId}')">Process Selected Loads</button></div></div></div></div>`);
         });
    }

    // =========================================================
    // =============== ACTION HANDLERS =======================
    // =========================================================
    function getLoadItemHtml() {
        const truckOptions = MASTER_DATA.truckTypes.map(p => `<option value='${p.truck_type_id}'>${p.truck_name} (${p.dala_length_feet} ft)</option>`).join('');
        const itemOptions = MASTER_DATA.items.map(p => `<option value='${p.item_id}'>${p.item_name}</option>`).join('');
        return `<div class="card card-body mb-3"><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Loading Point Full Address</label><textarea class="form-control loading-point" rows="3" placeholder="Full address with contact details and PIN code" required></textarea></div><div class="col-md-6 mb-3"><label class="form-label">Unloading Point Full Address</label><textarea class="form-control unloading-point" rows="3" placeholder="Full address with contact details and PIN code" required></textarea></div></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Material / Item</label><select class="form-select item-id-select" required><option value="">Select Material...</option>${itemOptions}</select></div><div class="col-md-6 mb-3"><label class="form-label">Approx. Weight (in Metric Tonnes)</label><input type="number" step="0.01" class="form-control weight" placeholder="e.g., 15.5" required></div></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Required Truck Type</label><select class="form-select truck-type-select" required><option value="">Select Truck Type...</option>${truckOptions}</select></div><div class="col-md-6 mb-3"><label>Requirement Date</label><input type="date" class="form-control req-date" required></div></div></div>`;
    }
    
    async function handleLoadSubmit(e) {
        e.preventDefault();
        const card = $('#load-items-container .card-body');
        const payload = {
            loading_point_address: card.find('.loading-point').val(),
            unloading_point_address: card.find('.unloading-point').val(),
            item_id: card.find('.item-id-select').val(),
            approx_weight_tonnes: card.find('.weight').val(),
            truck_type_id: card.find('.truck-type-select').val(),
            requirement_date: card.find('.req-date').val(),
        };
        const result = await apiCall('/requisitions', 'POST', { items: JSON.stringify([payload]) });
        if (result.success) {
            showToast(result.message, 'success');
            navigateTo('user-create-load-view');
        }
    }
    
    async function handleBulkBidSubmit() {
        const bidsToSubmit = [];
        $('#vendor-loads-tbody tr').each(function() {
            const row = $(this);
            const bidAmountInput = row.find('.bid-amount');
            if (bidAmountInput.val()) {
                bidsToSubmit.push({ itemId: row.data('load-id'), bid_amount: parseFloat(bidAmountInput.val()) });
            }
        });
        if (bidsToSubmit.length === 0) return showToast('No new bids were entered.', 'warning');
        const result = await apiCall('/bids/bulk', 'POST', { bids: bidsToSubmit });
        if (result.success) {
            showToast(result.message, 'success');
            load_vendor_open_loads_view();
        }
    }

    async function handleBulkApproval(reqId) {
        const container = $(`#collapse-${reqId}`);
        const approvedLoadIds = container.find('.load-check-box:checked').map((i, el) => $(el).val()).get();
        const truckerAssignments = container.find('.trucker-assign-check:checked').map((i, el) => $(el).val()).get();
        if (approvedLoadIds.length === 0) {
            return alert("Please select at least one load to approve.");
        }
        if (truckerAssignments.length === 0) {
            return alert("Please assign at least one trucker.");
        }
        const result = await apiCall('/requisitions/approve', 'POST', { approvedItemIds: approvedLoadIds, vendorAssignments: truckerAssignments, requisitionId: reqId });
        if (result.success) {
            showToast(result.message, 'success');
            load_admin_pending_loads_view();
        }
    }

    // =========================================================
    // ================ UTILITY FUNCTIONS ======================
    // =========================================================
    function renderEmptyState(containerSelector, message, iconClass = 'fa-folder-open') { $(containerSelector).html(`<div class="empty-state"><i class="fas ${iconClass}"></i><p>${message}</p></div>`); }
    function showToast(m,t='info'){const c=$('#toast-container'),e=$(`<div><i class="fas ${t === 'success' ? 'fa-check-circle' : 'fa-times-circle'} me-2"></i><span>${m}</span></div>`).addClass(`toast-notification ${t}`);c.append(e);setTimeout(()=>e.remove(),5000)}
    function showLoader(){$('#loader-overlay').css('display', 'flex')}
    function hideLoader(){$('#loader-overlay').css('display', 'none')}
    function formatCurrency(v){const n=parseFloat(v);return isNaN(n)?'₹0.00':`₹${n.toLocaleString('en-IN',{minimumFractionDigits:0,maximumFractionDigits:0})}`}
    function getBadgeColor(s){return {'Awarded':'primary','Active':'success','Pending Approval':'warning','Submitted':'info','Rejected':'danger','Processed': 'secondary'}[s]||'dark'}
    function formatDate(dateString) { if (!dateString) return 'N/A'; const date = new Date(dateString); const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone; return date.toLocaleString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', timeZone: userTimezone }); }
    function toggleAllInParent(source, targetClass) { $(source).closest('.accordion-body').find(`input[type="checkbox"].${targetClass}`).prop('checked', source.checked); }

    </script>
</body>
</html>
